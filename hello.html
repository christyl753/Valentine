<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surprise</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>
    <link rel="shortcut icon" href="icon/box.svg" type="image/x-icon">
</head>
<body>
    <div class="message">
        <dotlottie-wc
            src="https://lottie.host/ada07a8e-dec1-46d2-9db3-d27b816df158/y1TkGGfnXo.lottie"
            speed="0.75"
            autoplay
            loop
        ></dotlottie-wc>
        
        <h1 id="greeting">VEUX TU ETRE MA VALENTINE ?</h1>
        
        <div id="question">
            <button class="answer" id="yes">Oui</button>
            <button class="answer" id="no">Non</button>
        </div>
        
        <p>Bien sÃ»r, je ne te force pas.</p>
    </div>

    <script>
        const sessionId = localStorage.getItem('valentine_session_id');

        // 1. RÃ©cupÃ©rer le nom pour l'afficher
        if (sessionId) {
            fetch(`/api/user-data?sessionId=${sessionId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.name) {
                        document.getElementById("greeting").innerText = `${data.name.toUpperCase()}, VEUX TU ETRE MA VALENTINE ?`;
                    }
                })
                .catch(err => console.error("Erreur nom:", err));
        }

        async function sendAnswer(answer) {
            if (!sessionId) return;
            try {
                await fetch('/api/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, answer })
                });
            } catch (e) { console.error(e); }
        }

        // Gestion du OUI
        document.getElementById('yes').addEventListener('click', async () => {
            await sendAnswer('oui');
            document.body.innerHTML = `
                <div class="message">
                    <dotlottie-wc src="https://lottie.host/25eb1912-f42f-430e-ac57-30a9fd067929/JHQBgiluvG.lottie" speed="0.75" autoplay loop></dotlottie-wc>
                    <h1>MERCI D'AVOIR ACCEPTÃ‰ ðŸ’–</h1>
                </div>
            `;
        });
        
        // Gestion du NON (sans fuite)
        document.getElementById('no').addEventListener('click', async () => {
            await sendAnswer('non');
            document.body.innerHTML = `
                <div class="message" style="min-height:100vh; justify-content:center;">
                    <dotlottie-wc src="https://lottie.host/0093e7b7-be68-498f-8cfd-7e651301159b/SX4DYhZRPR.lottie" autoplay loop></dotlottie-wc>
                    <h1 style="font-size:20px; text-align:center; margin-top:12px;">J'accepte ton choix â€” merci d'avoir rÃ©pondu</h1>
                </div>
            `;
        });
    </script>
</body>
</html>